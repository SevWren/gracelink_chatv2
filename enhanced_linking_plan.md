
# Plan: Implementing Enhanced Linking & Navigation for Headings

## 1. Introduction and Goals

**1.1. What are `rehype-slug` and `rehype-autolink-headings`?**
-   **`rehype-slug`:** A rehype (HTML processor) plugin that adds `id` attributes (slugs) to headings (`<h1>` to `<h6>`) in HTML content. These IDs are typically generated based on the heading's text content, making them unique and linkable.
-   **`rehype-autolink-headings`:** Another rehype plugin that enhances headings by automatically adding links (`<a>` tags) that point to the `id` generated by `rehype-slug` (or existing IDs). This allows users to directly link to specific sections of the content.

**1.2. Why Integrate Them?**
Integrating these plugins into the Gemini Chatbot will:
-   **Improve Navigation in Long Messages:** For lengthy AI responses with multiple sections, users can easily navigate or share links to specific headings.
-   **Enable Deep Linking:** Users or the application itself can construct URLs that jump directly to a section.
-   **Foundation for Table of Contents (Future):** Generated heading IDs are essential if a Table of Contents feature were to be implemented later.
-   **Enhance User Experience & Accessibility:** Provides a powerful way to interact with structured content, especially for users relying on assistive technologies or keyboard navigation.

**1.3. High-Level Implementation Strategy**
The core strategy involves:
1.  Installing `rehype-slug` and `rehype-autolink-headings`.
2.  Adding them to the `rehypePlugins` array in `ChatMessageItem.tsx`, ensuring correct order.
3.  Configuring `rehype-autolink-headings` for desired behavior, link appearance (e.g., using an icon), and crucial accessibility properties.
4.  Styling the autogenerated links to be unobtrusive yet discoverable and accessible (e.g., appear on hover, clear focus indicators).
5.  Updating the `rehype-sanitize` configuration to allow the attributes and elements added by these plugins.
6.  Optionally, updating the system prompt to inform the AI that headings will be linkable (though this is more of a user-facing enhancement).

## 2. Prerequisites and Dependencies

**2.1. Core Libraries:**
-   `rehype-slug`: The plugin to generate `id` attributes for headings.
-   `rehype-autolink-headings`: The plugin to add `<a>` tags around or near headings.

**2.2. Compatibility:**
-   These plugins are part of the unified/rehype ecosystem and are designed to work with tools like `react-markdown`.
-   Ensure compatibility with the current versions of `react-markdown` and `rehype-sanitize` being used.

**2.3. TypeScript Typings:**
-   Generally, explicit typings for these plugins might not be strictly necessary for basic usage.
-   If complex configurations involving custom functions (like for `properties` or `content`) or HAST manipulation are used, relevant types (e.g., from `@types/hast`) might be helpful.

## 3. Installation

**3.1. Install via npm/yarn:**
Execute the following command in the project's root directory:
```bash
npm install rehype-slug rehype-autolink-headings
# or
# yarn add rehype-slug rehype-autolink-headings
```

## 4. Integration with `react-markdown` (`ChatMessageItem.tsx`)

Modify the `rehypePlugins` array passed to the `ReactMarkdown` component.

**4.1. Order of Plugins:**
The order is crucial:
1.  `rehype-slug` must run first to generate the `id` attributes on headings.
2.  `rehype-autolink-headings` runs next to use these `id`s for creating links.
3.  `rehype-sanitize` should run after these plugins to allow new HTML elements or attributes.

**4.2. Configuration Example:**
```typescript
// In ChatMessageItem.tsx
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import rehypeSanitize, { defaultSchema } from 'rehype-sanitize';
import rehypeSlug from 'rehype-slug';
import rehypeAutolinkHeadings from 'rehype-autolink-headings';
// ... other imports

// ... (customSanitizeSchema defined below in section 6.2)

const markdownComponents = {
  // ... your existing components (code, a, etc.)
};

// Inside ChatMessageItem component's return statement:
// <ReactMarkdown
//   components={markdownComponents}
//   remarkPlugins={[remarkGfm]}
//   rehypePlugins={[
//     rehypeSlug,
//     [rehypeAutolinkHeadings, {
//       behavior: 'append', // Options: 'prepend', 'wrap', 'before', 'after'. 'append' or 'prepend' are common.
//       properties: (node) => { // HAST node for the heading
//         let headingText = '';
//         // Simplified text extraction from HAST heading node.
//         // For complex children (e.g. multiple nested inline elements), a more robust HAST traversal might be needed.
//         if (node.children && node.children.length > 0) {
//           node.children.forEach(child => {
//             if (child.type === 'text') {
//               headingText += child.value;
//             } else if (child.type === 'element' && child.tagName === 'code' && child.children && child.children[0]?.type === 'text') {
//               headingText += child.children[0].value; // Extract text from inline code
//             } else if (child.type === 'element' && child.children) { // Handle simple nested elements like <em>
//                child.children.forEach(grandChild => {
//                  if (grandChild.type === 'text') headingText += grandChild.value;
//                });
//             }
//           });
//           headingText = headingText.trim();
//         }
//         const label = headingText ? \`Link to section: ${headingText}\` : 'Link to this section';
//         return {
//           className: ['heading-link-anchor'], // For styling
//           'aria-label': label, // Crucial for accessibility
//           title: label, // Provides a browser tooltip
//           // DO NOT use ariaHidden: true or tabIndex: -1 on the link itself if it's interactive
//         };
//       },
//       content: (node) => ({ // HAST representation for the link content (e.g., a link icon)
//         type: 'element',
//         tagName: 'svg',
//         properties: {
//           xmlns: 'http://www.w3.org/2000/svg',
//           fill: 'none',
//           viewBox: '0 0 24 24',
//           strokeWidth: '2', // Thicker stroke for better visibility
//           stroke: 'currentColor',
//           className: 'heading-link-icon w-4 h-4 sm:w-5 sm:h-5 ml-1.5 inline-block align-middle',
//           'aria-hidden': 'true', // Icon is decorative as the <a> tag has aria-label
//         },
//         children: [{
//           type: 'element',
//           tagName: 'path',
//           properties: {
//             strokeLinecap: 'round',
//             strokeLinejoin: 'round',
//             d: 'M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244',
//           },
//         }],
//       }),
//       // Optional: group: (node) => ({ type: 'element', tagName: 'div', properties: {className: ['heading-group']} }), // Wraps heading and link
//       // Optional: test: (node) => node.tagName === 'h2' || node.tagName === 'h3', // Only link specific headings
//     }],
//     [rehypeSanitize, customSanitizeSchema] // Ensure this is correctly configured
//   ]}
// >
//   {message.text}
// </ReactMarkdown>
```

**4.3. `rehype-autolink-headings` Configuration Options:**
-   **`behavior: 'append'` (Recommended for icon links):** Places the link anchor after the heading text. `'prepend'` is also common. `'wrap'` makes the entire heading the link (good for text-only links or if the heading itself is the intended clickable area).
-   **`properties: (node) => { ... }` (Function for Dynamic Properties):**
    -   **Crucial for Accessibility:** This function receives the HAST node of the heading.
    -   It should return an object with properties for the `<a>` tag.
    -   `className`: For CSS styling.
    -   `'aria-label'`: **Essential.** Provide a descriptive label, e.g., "Link to section: [Heading Text]".
    -   `title`: Optional, provides a native browser tooltip.
    -   **Important:** Avoid `ariaHidden: true` or `tabIndex: -1` on the link anchor (`<a>`) itself if it's meant to be interactive. The link must be focusable and announceable.
-   **`content: (node) => ({ ... })` (Link Icon / Content):**
    -   Defines the HAST (HTML Abstract Syntax Tree) for what's inside the `<a>` tag. The example uses an SVG link icon.
    -   The icon itself should be marked as decorative (`aria-hidden="true"` on the `<svg>` tag) because the `<a>` tag will carry the accessible name.
-   **`group: (node) => ({ type: 'element', ... })` (Optional):**
    -   Wraps the heading and its link in a specified element (e.g., a `<div>`).
    -   Can simplify styling for hover effects (e.g., hover the group to show the link).
    -   Requires allowing this group element and its `className` in `rehype-sanitize`.
-   **`test: (node) => ...` (Optional):** A function to filter which headings get autolinked (e.g., only `h2` and `h3`). By default, it links `h1` through `h6`.

## 5. Styling the Autogenerated Links (`index.html`)

Add CSS to style the heading links. The goal is an unobtrusive link that becomes apparent on hover/focus.

```css
/* In index.html <style> tags */

/* Ensure headings can be targets for scroll-margin */
.markdown-content h1,
.markdown-content h2,
.markdown-content h3,
.markdown-content h4,
.markdown-content h5,
.markdown-content h6 {
  scroll-margin-top: 1.5rem; /* Adjust based on any sticky header height + desired spacing */
  position: relative; /* If using 'group' behavior or for advanced hover effects on the heading itself */
}

/* The autogenerated link anchor */
.heading-link-anchor {
  opacity: 0; /* Hidden by default */
  transition: opacity 0.2s ease-in-out;
  text-decoration: none;
  color: #9ca3af; /* slate-400 */
  margin-left: 0.375rem; /* Equivalent to ml-1.5 Tailwind for spacing after heading text */
  display: inline-block; /* Allows vertical alignment */
  vertical-align: middle; /* Aligns icon nicely with text */
}

.heading-link-anchor:hover,
.heading-link-anchor:focus-visible { /* Use focus-visible for better keyboard focus styling */
  opacity: 1;
  color: #60a5fa; /* blue-400 */
  text-decoration: none; /* Ensure no underline on icon */
}

/* Explicit focus styling for accessibility */
.heading-link-anchor:focus-visible {
  outline: 2px solid #3b82f6; /* blue-500 or your app's focus color */
  outline-offset: 2px;
  border-radius: 2px; /* Optional: slightly round the focus outline */
}

/* Show link on hover/focus of the heading itself (if not using 'group' behavior) */
/* This makes the link discoverable even before tabbing to it directly */
.markdown-content h1:hover > .heading-link-anchor,
.markdown-content h2:hover > .heading-link-anchor,
.markdown-content h3:hover > .heading-link-anchor,
.markdown-content h4:hover > .heading-link-anchor,
.markdown-content h5:hover > .heading-link-anchor,
.markdown-content h6:hover > .heading-link-anchor,
.markdown-content h1:focus-within > .heading-link-anchor, /* Shows when children (like the anchor itself) are focused */
.markdown-content h2:focus-within > .heading-link-anchor,
.markdown-content h3:focus-within > .heading-link-anchor,
.markdown-content h4:focus-within > .heading-link-anchor,
.markdown-content h5:focus-within > .heading-link-anchor,
.markdown-content h6:focus-within > .heading-link-anchor {
  opacity: 0.75; /* Or 1, depending on desired visibility */
}

/* If using the 'group' behavior from rehype-autolink-headings: */
/*
.heading-group {
  position: relative;
}
.heading-group:hover .heading-link-anchor {
  opacity: 1;
}
*/

/* Specific styling for the SVG icon inside the anchor */
.heading-link-icon {
  /* className in plugin config: 'w-4 h-4 sm:w-5 sm:h-5 ml-1.5 inline-block align-middle' */
  /* Styles are applied via Tailwind utilities. Add !important here if Tailwind specificity is an issue. */
}
```
**Note on Styling Approach:** The CSS aims for `behavior: 'append'`. The link appears to the right of the heading text. Hovering the heading text (or its group) makes the link visible. The link itself also has hover and focus states.

## 6. `rehype-sanitize` Configuration

Update your `customSanitizeSchema` in `ChatMessageItem.tsx`.

**6.1. Schema Update Example:**
```typescript
// In ChatMessageItem.tsx, where customSanitizeSchema is defined:

const customSanitizeSchema = {
  ...defaultSchema,
  tagNames: [ // If using the 'group' option with a 'div'
    ...(defaultSchema.tagNames || []),
    // 'div', // Example: If group behavior wraps in a div
  ],
  attributes: {
    ...defaultSchema.attributes,
    // Allow 'id' on all heading tags
    h1: [...(defaultSchema.attributes?.h1 || []), 'id', 'className'], // Allow className if you style headings directly
    h2: [...(defaultSchema.attributes?.h2 || []), 'id', 'className'],
    h3: [...(defaultSchema.attributes?.h3 || []), 'id', 'className'],
    h4: [...(defaultSchema.attributes?.h4 || []), 'id', 'className'],
    h5: [...(defaultSchema.attributes?.h5 || []), 'id', 'className'],
    h6: [...(defaultSchema.attributes?.h6 || []), 'id', 'className'],
    // Allow specific attributes for the autogenerated <a> tags
    a: [
      ...(defaultSchema.attributes?.a || []),
      'className', // For 'heading-link-anchor'
      'aria-label', // For accessibility
      'title', // For tooltips
      // 'href' is already in defaultSchema.attributes.a
      // 'ariaHidden' and 'tabIndex' are NOT needed on the <a> tag itself.
    ],
    // For the SVG icon and its path
    svg: [
      ...(defaultSchema.attributes?.svg || []),
      'xmlns', 'fill', 'viewBox', 'strokeWidth', 'stroke', 'className', 'aria-hidden',
    ],
    path: [
      ...(defaultSchema.attributes?.path || []),
      'strokeLinecap', 'strokeLinejoin', 'd',
    ],
    // If using 'group' behavior with a div and giving it a className
    // div: [
    //   ...(defaultSchema.attributes?.div || []),
    //   'className', // For 'heading-group'
    // ],
    // Allow 'role' on headings if you add them for landmark purposes (optional)
    // '*': [...(defaultSchema.attributes?.['*'] || []), 'role'],
  },
};
```
**Important:** The `customSanitizeSchema` needs to be comprehensive for all SVG elements and attributes used by your chosen link icon and any grouping elements. Inspect the generated HTML if links or icons are being stripped.

## 7. System Prompt Update (`hooks/useChatSettings.ts`)

This feature is primarily for user navigation and doesn't require specific AI action, but informing the AI can be good practice.

```diff
// In hooks/useChatSettings.ts
export const DEFAULT_SYSTEM_INSTRUCTION = \`You are a helpful and friendly AI assistant. Please use Markdown formatting in your responses for clarity and structure. This interface supports:
- Headers (\`# H1\` to \`###### H6\`) (Headings in longer messages are automatically linkable for easier navigation.)
- Emphasis (\`**bold**\`, \`*italic*\`, \`~~strikethrough~~\`)
...
\`;
```

## 8. Accessibility (A11y) Considerations

-   **Link Purpose:** The `<a>` tag itself must have a clear, accessible name, typically set via `aria-label` derived from the heading text.
-   **Icon as Decorative:** The SVG icon inside the link should be marked as decorative (`aria-hidden="true"`) since the `<a>` tag provides the accessible name.
-   **Focusability:** The `<a>` tag must be focusable. Do not use `tabIndex="-1"` on it. Provide clear `:focus-visible` styling.
-   **Keyboard Navigation:** Users must be able to tab to the links and activate them using Enter/Space.
-   **Screen Readers:** Test thoroughly. Screen readers should announce the links correctly (e.g., "Link to section: Introduction").
-   **Scroll Behavior:** Ensure `scroll-margin-top` on headings prevents them from being hidden under a sticky header when jumping to an ID.

## 9. Potential Challenges & Edge Cases

-   **Complex Heading Content:** Headings with inline Markdown (bold, code, links) should still generate valid slugs and links. The text extraction for `aria-label` might need to be robust.
-   **Duplicate Slugs:** `rehype-slug` appends numbers to make slugs unique if duplicates occur. This is generally handled well.
-   **Styling Conflicts:** Ensure link icon styling doesn't conflict with other page styles or heading content.
-   **Performance:** For typical chat message lengths, performance impact should be negligible.

## 10. Development and Testing Plan

1.  **Install Dependencies.**
2.  **Basic Integration:** Add to `rehypePlugins` with minimal config.
3.  **Verify ID Generation:** Inspect HTML for `id` attributes on headings.
4.  **Configure `rehypeAutolinkHeadings`:**
    -   Set `behavior`.
    -   Implement `properties` function for `className`, `aria-label`, `title`.
    -   Implement `content` function for SVG icon with `aria-hidden="true"`.
5.  **Verify Link Generation:** Inspect HTML for `<a>` tags with correct `href`, `aria-label`, and icon.
6.  **Styling:** Implement CSS for link appearance (default, hover, focus-visible) and `scroll-margin-top`.
7.  **Sanitization (`rehype-sanitize`):**
    -   Iteratively test and update `customSanitizeSchema`.
    -   Temporarily disable `rehypeSanitize` to inspect raw HTML from `rehype-autolink-headings`.
    -   Re-enable `rehypeSanitize` and adjust schema to allow necessary elements/attributes (e.g., `id` on headings; `a` with `className`, `aria-label`, `title`; `svg` with `aria-hidden`; `path`).
8.  **Test with Diverse Headings:** All levels (`h1`-`h6`), headings with inline formatting, special characters, multiple headings.
9.  **Accessibility Testing (CRITICAL):**
    -   **Keyboard Navigation:** Ensure each link is focusable and activatable. Check tab order.
    -   **Screen Reader:** Verify links are announced correctly (e.g., "Link to section: Introduction"). Navigation should be logical.
    -   **Focus Indicators:** Ensure `:focus-visible` styles are clear.
10. **Click and Scroll Behavior:** Verify clicking links scrolls the correct heading into view and `scroll-margin-top` works.
11. **Cross-Browser Check:** Basic check (Chrome, Firefox, Safari).
12. **System Prompt Update (Optional).**
13. **Review and Refine:** Code cleanup, comments, consistency.

This revised plan provides a robust roadmap for implementing accessible and user-friendly enhanced linking for headings.
